
global
#   debug
    daemon
    log                 127.0.0.1    local0


  defaults
        mode http
        timeout connect 5000ms
        timeout client 50000ms
        timeout server 50000ms
        option  http-server-close
    log                 global
    option              httplog
        
  frontend  secured
    bind            0.0.0.0:443 ssl crt /certs/chain.pem
    mode            http
    log         global
    option          httplog
    timeout         client   3600s
    backlog         4096
    maxconn         50000      
        option          httpclose
    option          tcpka

        acl is_upgrade hdr(Connection) -i upgrade
        acl is_websocket hdr(Upgrade) -i websocket
        use_backend be_isard-html5 if is_websocket

    acl is_remote-viewer hdr(user-agent) -i GLib2
        use_backend be_isard-spice if is_remote-viewer

    use_backend be_isard-static if { path_beg /static/spice-web-client }

        default_backend         be_isard-ui

  backend be_isard-html5
#        acl hdr_websocket_key      hdr_cnt(Sec-WebSocket-Key)      eq 1
#        acl hdr_websocket_version  hdr_cnt(Sec-WebSocket-Version)  eq 1
#        http-request deny if ! hdr_websocket_key ! hdr_websocket_version
        option forwardfor
        server html5 isard-html5:8080 cookie html5 check

  backend be_isard-spice
    option forwardfor
        server spice isard-spice:8080 cookie spice check

  backend be_isard-static
        server static isard-static:80 maxconn 100 weight 10 cookie static 

  backend be_isard-ui
    option forwardfor
        server isard-ui isard-ui:5000 maxconn 10000 weight 5 cookie static check port 5000

  listen stats 
        bind                    0.0.0.0:8888
        mode                http
        stats               enable
        option              httplog
        stats               show-legends
        stats               uri /haproxy
        stats               realm Haproxy\ Statistics
        stats               refresh 5s
        stats               auth user:pass
        timeout             connect 5000ms
        timeout             client 50000ms
        timeout             server 50000ms
